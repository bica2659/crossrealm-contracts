<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>CrossRealm • On-Chain Checkers & Chess on Core</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --bitcoin-orange: #f7931a;
            --burnt-orange: #cc6600;
            --core-green: #00ff88;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #999;
            --success: var(--core-green);
            --error: #ff4444;
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: var(--card-bg);
            border: 2px solid var(--bitcoin-orange);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--bitcoin-orange);
        }
        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--bitcoin-orange), var(--burnt-orange));
            color: #000;
            border-color: var(--bitcoin-orange);
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--bitcoin-orange), var(--burnt-orange));
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--core-green);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none !important;
        }
        .board-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 400px;
            border: 2px solid var(--border);
            margin: 20px auto;
            background: #2a1810;
        }
        .square {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            user-select: none;
            border: 1px solid rgba(0,0,0,0.3);
        }
        .square.light {
            background: #DEB887;
        }
        .square.dark {
            background: #8B4513;
        }
        .square.selected {
            background: #4169E1 !important;
        }
        .square.possible {
            background: #FFD700 !important;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--core-green), #00cc6a);
            color: #000;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        .game-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .game-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        input, select {
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            border-radius: 4px;
            font-family: inherit;
        }
        label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .game-info {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid var(--border);
        }
        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">CrossRealm</h1>
            <p style="color: var(--text-dim); font-size: 11px; margin-top: 5px;">On-Chain Checkers & Chess on Core</p>
            <div style="margin-top: 10px;">
                <button id="connectBtn" style="margin-right: 10px;">Connect Wallet</button>
                <button id="disconnectBtn" class="hidden">Disconnect</button>
                <span id="walletStatus" style="margin-left: 10px; color: var(--text-dim);">Not Connected</span>
            </div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" data-tab="home">Home</button>
            <button class="tab-btn" data-tab="games">Games</button>
            <button class="tab-btn" data-tab="profile">Profile</button>
        </div>

        <div id="home" class="tab-content">
            <div class="card">
                <h2>Welcome to CrossRealm</h2>
                <p style="margin: 10px 0;">Play on-chain chess and checkers with real stakes and rewards.</p>
                <div class="stats-grid" id="globalStats"></div>
            </div>
            <div class="card">
                <h3>Create Game</h3>
                <div class="input-group">
                    <select id="gameType">
                        <option value="chess">Chess</option>
                        <option value="checkers">Checkers</option>
                    </select>
                    <input type="number" id="stakeAmount" placeholder="Stake (CORE)" min="0.1" step="0.1" value="1">
                    <label><input type="checkbox" id="isPrivate"> Private Game</label>
                    <button id="createGameBtn">Create Game</button>
                </div>
            </div>
        </div>

        <div id="games" class="tab-content hidden">
            <div class="card">
                <h3>Active Games</h3>
                <div id="gamesList" class="game-list"></div>
            </div>
            <div id="gameBoard" class="card hidden">
                <h3>Game Board</h3>
                <div class="game-info" id="gameInfo"></div>
                <div class="board-container" id="board"></div>
                <div class="game-controls">
                    <button id="resignBtn" style="background: #ff4444;">Resign</button>
                    <button id="claimWinBtn">Claim Win</button>
                </div>
            </div>
        </div>

        <div id="profile" class="tab-content hidden">
            <div class="card">
                <h3>Your Profile</h3>
                <div id="userStats" class="stats-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            // LIVE MAINNET ADDRESSES
            HUB_ADDRESS: '0xD2Ff26ff20F8ca249b33808d85C38C16e6b9721f',
            VERIFIER_ADDRESSES: {
                chess: '0xFa1463b462d937b4F3ffD4675E1F5bA6Dac9884E',
                checkers: '0x634cBAE767EdabBa207FA7c2e790808A2bFDB3DD'
            },
            CORE_TOKEN: '0x0000000000000000000000000000000000000000',

            HUB_ABI: [
                "function gameCount() view returns (uint)",
                "function games(uint) view returns (tuple(uint id, string gameType, uint stake, address token, address creator, address player2, bool isAI, bool isPrivate, address referral, bool zeroGas, bool active, string fen, address verifier, uint turn))",
                "function createGame(string _gameType, uint _stake, address _token, bool _isPrivate, address _referral, bool _isAI, bool _zeroGas, address _verifier) payable",
                "function joinGame(uint _gameId) payable",
                "function makeMove(uint _gameId, string _move, string _newFen, bytes _proof) external",
                "function endGame(uint _gameId, bool _creatorWins) external"
            ],

            // Global state
            provider: null,
            signer: null,
            userAddress: null,
            hubContract: null,
            currentGameId: null,
            currentGame: null,
            selectedSquare: null,
            gameChess: null,

            // Piece symbols
            pieceSymbols: {
                'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙',
                'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟'
            },

            // Initialize
            async init() {
                this.setupEventListeners();
                this.loadTheme();
            },

            setupEventListeners() {
                document.getElementById('connectBtn').onclick = () => this.connectWallet();
                document.getElementById('disconnectBtn').onclick = () => this.disconnect();
                document.getElementById('createGameBtn').onclick = () => this.createGame();
                document.getElementById('resignBtn').onclick = () => this.resignGame();
                document.getElementById('claimWinBtn').onclick = () => this.claimWin();

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.onclick = (e) => this.switchTab(e.target.dataset.tab);
                });
            },

            async connectWallet() {
                try {
                    if (!window.ethereum) {
                        this.alert('Please install MetaMask!', 'error');
                        return;
                    }
                    this.provider = new ethers.providers.Web3Provider(window.ethereum);
                    await this.provider.send("eth_requestAccounts", []);
                    this.signer = this.provider.getSigner();
                    this.userAddress = await this.signer.getAddress();
                    this.hubContract = new ethers.Contract(this.HUB_ADDRESS, this.HUB_ABI, this.signer);
                    this.updateWallet();
                    this.loadGlobalStats();
                    this.alert('Wallet connected!', 'success');
                } catch (error) {
                    this.alert('Connection failed: ' + error.message, 'error');
                }
            },

            disconnect() {
                this.userAddress = null;
                this.signer = null;
                this.updateWallet();
                this.alert('Wallet disconnected', 'info');
            },

            updateWallet() {
                const statusEl = document.getElementById('walletStatus');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                if (this.userAddress) {
                    statusEl.textContent = `${this.userAddress.slice(0,6)}...${this.userAddress.slice(-4)}`;
                    connectBtn.classList.add('hidden');
                    disconnectBtn.classList.remove('hidden');
                } else {
                    statusEl.textContent = 'Not Connected';
                    connectBtn.classList.remove('hidden');
                    disconnectBtn.classList.add('hidden');
                }
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(tabName).classList.remove('hidden');
                event.target.classList.add('active');

                if (tabName === 'games') this.loadGames();
                if (tabName === 'profile') this.loadProfile();
            },

            async loadGlobalStats() {
                try {
                    if (!this.hubContract) return;
                    const gameCount = await this.hubContract.gameCount();
                    document.getElementById('globalStats').innerHTML = `
                        <div class="stat-card">Total Games<br>${gameCount}</div>
                        <div class="stat-card">Active Players<br>256</div>
                        <div class="stat-card">Total Staked<br>50,000 CORE</div>
                    `;
                } catch (e) {
                    console.error('Stats error:', e);
                }
            },

            async loadGames() {
                const listEl = document.getElementById('gamesList');
                try {
                    if (!this.hubContract) {
                        listEl.innerHTML = '<p>Connect wallet to view games</p>';
                        return;
                    }
                    const count = await this.hubContract.gameCount();
                    let html = '';
                    
                    // Load last 10 games
                    for (let i = count.toNumber(); i >= Math.max(1, count.toNumber() - 10); i--) {
                        try {
                            const game = await this.hubContract.games(i);
                            if (game.active) {
                                const opponent = game.player2 === '0x0000000000000000000000000000000000000000' 
                                    ? 'Open' : game.player2.slice(0, 6) + '...';
                                const isMyGame = game.creator.toLowerCase() === this.userAddress?.toLowerCase() ||
                                               game.player2.toLowerCase() === this.userAddress?.toLowerCase();
                                
                                html += `
                                    <div class="game-item">
                                        <div>
                                            <strong>${game.gameType} Game #${i}</strong><br>
                                            Stake: ${ethers.utils.formatEther(game.stake)} CORE<br>
                                            Opponent: ${opponent}
                                        </div>
                                        <div>
                                            ${isMyGame ? '<span style="color: var(--core-green);">Your Game</span>' : ''}
                                            <button onclick="window.app.viewGame(${i})" style="margin-left: 10px;">View</button>
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.error('Game load error:', e);
                        }
                    }
                    listEl.innerHTML = html || '<p>No active games</p>';
                } catch (e) {
                    console.error('Load games error:', e);
                    listEl.innerHTML = '<p>Error loading games</p>';
                }
            },

            async viewGame(id) {
                try {
                    if (!this.hubContract) return;
                    this.currentGameId = id;
                    this.currentGame = await this.hubContract.games(id);
                    
                    if (!this.currentGame.active) {
                        this.alert('Game is not active', 'error');
                        return;
                    }
                    
                    document.getElementById('gameBoard').classList.remove('hidden');
                    
                    const opponent = this.currentGame.player2 === '0x0000000000000000000000000000000000000000' 
                        ? 'Open' : this.currentGame.player2.slice(0, 6) + '...';
                    
                    document.getElementById('gameInfo').innerHTML = `
                        <h4>Game #${id}</h4>
                        <p><strong>Type:</strong> ${this.currentGame.gameType}</p>
                        <p><strong>Stake:</strong> ${ethers.utils.formatEther(this.currentGame.stake)} CORE</p>
                        <p><strong>Opponent:</strong> ${opponent}</p>
                        <p><strong>Your Turn:</strong> ${this.currentGame.turn === 0 ? 'Creator' : 'Player 2'}</p>
                    `;
                    
                    this.renderBoard();
                } catch (e) {
                    console.error('View game error:', e);
                    this.alert('Error loading game: ' + e.message, 'error');
                }
            },

            renderBoard() {
                const boardEl = document.getElementById('board');
                boardEl.innerHTML = '';
                
                try {
                    if (this.currentGame.gameType === 'chess') {
                        this.gameChess = new Chess(this.currentGame.fen);
                        const board = this.gameChess.board();
                        
                        for (let row = 0; row < 8; row++) {
                            for (let col = 0; col < 8; col++) {
                                const square = document.createElement('div');
                                square.className = `square ${((7-row) + col) % 2 === 0 ? 'light' : 'dark'}`;
                                square.dataset.row = row;
                                square.dataset.col = col;
                                
                                const piece = board[row][col];
                                if (piece) {
                                    const key = piece.color === 'w' 
                                        ? piece.type.toUpperCase() 
                                        : piece.type.toLowerCase();
                                    square.textContent = this.pieceSymbols[key] || '';
                                }
                                
                                square.onclick = () => this.handleSquareClick(square);
                                boardEl.appendChild(square);
                            }
                        }
                    } else {
                        // Checkers board
                        for (let row = 0; row < 8; row++) {
                            for (let col = 0; col < 8; col++) {
                                const square = document.createElement('div');
                                square.className = `square ${(row + col) % 2 === 0 ? 'dark' : 'light'}`;
                                square.dataset.row = row;
                                square.dataset.col = col;
                                
                                if (row < 3 && (row + col) % 2 === 0) {
                                    square.textContent = '●';
                                    square.style.color = '#000';
                                } else if (row > 4 && (row + col) % 2 === 1) {
                                    square.textContent = '○';
                                    square.style.color = '#fff';
                                }
                                
                                boardEl.appendChild(square);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Board render error:', e);
                    boardEl.innerHTML = '<p>Error rendering board</p>';
                }
            },

            handleSquareClick(squareEl) {
                const row = parseInt(squareEl.dataset.row);
                const col = parseInt(squareEl.dataset.col);
                
                if (this.selectedSquare) {
                    this.makeMove(this.selectedSquare.row, this.selectedSquare.col, row, col);
                    this.selectedSquare = null;
                    this.clearHighlights();
                } else {
                    this.selectedSquare = {row, col};
                    squareEl.classList.add('selected');
                }
            },

            async makeMove(fromRow, fromCol, toRow, toCol) {
                try {
                    if (!this.hubContract) return;
                    
                    if (this.currentGame.gameType === 'chess' && this.gameChess) {
                        const from = String.fromCharCode(97 + fromCol) + (8 - fromRow);
                        const to = String.fromCharCode(97 + toCol) + (8 - toRow);
                        const move = this.gameChess.move({from, to, promotion: 'q'});
                        
                        if (!move) {
                            this.alert('Invalid move', 'error');
                            return;
                        }
                        
                        const newFen = this.gameChess.fen();
                        const tx = await this.hubContract.makeMove(this.currentGameId, move.san, newFen, '0x');
                        this.alert('Move submitted...', 'info');
                        await tx.wait();
                        this.alert('Move executed!', 'success');
                        this.viewGame(this.currentGameId);
                    }
                } catch (e) {
                    console.error('Move error:', e);
                    this.alert('Move failed: ' + e.message, 'error');
                }
            },

            clearHighlights() {
                document.querySelectorAll('.square').forEach(sq => {
                    sq.classList.remove('selected', 'possible');
                });
            },

            async createGame() {
                try {
                    if (!this.hubContract || !this.userAddress) {
                        this.alert('Connect wallet first', 'error');
                        return;
                    }
                    
                    const gameType = document.getElementById('gameType').value;
                    const stakeStr = document.getElementById('stakeAmount').value;
                    
                    if (!stakeStr || parseFloat(stakeStr) <= 0) {
                        this.alert('Enter valid stake amount', 'error');
                        return;
                    }
                    
                    const stake = ethers.utils.parseEther(stakeStr);
                    const isPrivate = document.getElementById('isPrivate').checked;
                    const verifier = this.VERIFIER_ADDRESSES[gameType];
                    
                    const tx = await this.hubContract.createGame(
                        gameType, stake, this.CORE_TOKEN, isPrivate,
                        ethers.constants.AddressZero, false, false, verifier,
                        { value: stake }
                    );
                    
                    this.alert('Creating game...', 'info');
                    await tx.wait();
                    this.alert('Game created! Tx: ' + tx.hash.slice(0, 10) + '...', 'success');
                    document.getElementById('stakeAmount').value = '';
                    this.loadGames();
                    this.switchTab('games');
                } catch (e) {
                    this.alert('Create failed: ' + (e.reason || e.message), 'error');
                }
            },

            async claimWin() {
                try {
                    if (!this.hubContract) return;
                    const creatorWins = confirm('Did the creator win?');
                    const tx = await this.hubContract.endGame(this.currentGameId, creatorWins);
                    this.alert('Ending game...', 'info');
                    await tx.wait();
                    this.alert('Game ended!', 'success');
                    document.getElementById('gameBoard').classList.add('hidden');
                    this.loadGames();
                } catch (e) {
                    this.alert('End game failed: ' + e.message, 'error');
                }
            },

            resignGame() {
                if (confirm('Resign and lose this game?')) {
                    this.claimWin();
                }
            },

            async loadProfile() {
                document.getElementById('userStats').innerHTML = '<div class="stat-card">Wins<br>0</div><div class="stat-card">Losses<br>0</div><div class="stat-card">ELO<br>1200</div>';
            },

            alert(msg, type = 'success') {
                const alertEl = document.createElement('div');
                alertEl.className = 'alert';
                alertEl.style.background = type === 'success' ? '#00cc6a' : type === 'error' ? '#ff4444' : '#f7931a';
                alertEl.textContent = msg;
                document.body.appendChild(alertEl);
                setTimeout(() => alertEl.remove(), 4000);
            },

            loadTheme() {
                // Load theme preference if saved
            }
        };

        // Start app
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
