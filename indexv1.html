<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossRealm ‚Ä¢ On-Chain Chess & Checkers</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-card: #1a1a1a;
            --accent: #f7931a;
            --accent-dark: #d97706;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #2a2a2a;
            --text-primary: #ffffff;
            --text-dim: #a0a0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a0f2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 15px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(247, 147, 26, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(247, 147, 26, 0.1) 100%);
            border: 1px solid rgba(247, 147, 26, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(247, 147, 26, 0.5);
        }

        .tagline {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 8px;
        }

        .wallet-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .wallet-status {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .wallet-address {
            color: var(--accent);
            font-weight: bold;
        }

        button {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(247, 147, 26, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .disconnect-btn {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
        }

        .alert-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            border-color: rgba(247, 147, 26, 0.3);
            box-shadow: 0 12px 40px rgba(247, 147, 26, 0.1);
        }

        .card-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            color: var(--text-dim);
            border: none;
            padding: 10px 16px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-btn:hover {
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(247, 147, 26, 0.3);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        small {
            color: var(--text-dim);
            font-size: 11px;
            display: block;
            margin-top: 5px;
        }

        .token-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
        }

        .token-item {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-symbol {
            color: var(--accent);
            font-weight: bold;
        }

        .token-chain {
            color: var(--text-dim);
            font-size: 10px;
        }

        .game-board {
            background: linear-gradient(135deg, #222 0%, #111 100%);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            aspect-ratio: 1;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .square {
            background: #333;
            border: 1px solid #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s;
        }

        .square:hover {
            background: #444;
        }

        .square.white {
            background: #ddd;
        }

        .square.selected {
            background: var(--accent);
            box-shadow: inset 0 0 10px rgba(247, 147, 26, 0.5);
        }

        .game-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .game-status {
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }

        .chat-window {
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
            font-size: 11px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 2px solid var(--accent);
            padding-left: 10px;
        }

        .chat-message.opponent {
            border-left-color: var(--warning);
        }

        .chat-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .chat-input-group input {
            flex: 1;
        }

        .chat-input-group button {
            flex: 0 0 60px;
        }

        .leaderboard-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .rank-badge {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--success) 100%);
            transition: width 0.5s ease;
        }

        .game-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .game-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
            font-size: 12px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-dim);
        }

        .modal-close:hover {
            color: var(--accent);
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-dim);
            font-size: 11px;
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }

        .footer-link {
            color: var(--accent);
            text-decoration: none;
            margin: 0 10px;
        }

        .hidden {
            display: none !important;
        }

        .tier-display {
            background: rgba(247, 147, 26, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                text-align: center;
            }
            .logo {
                font-size: 24px;
            }
            .game-board {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <div class="logo">‚ö° CROSSREALM</div>
                <div class="tagline">On-Chain Chess & Checkers ‚Ä¢ Core Mainnet ‚Ä¢ Pure Blockchain</div>
            </div>
            <div class="wallet-bar">
                <div class="wallet-status">
                    <span id="networkStatus">üî¥ Disconnected</span>
                    <span id="walletAddress" class="wallet-address"></span>
                </div>
                <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                <button id="disconnectBtn" class="disconnect-btn" style="display:none" onclick="disconnectWallet()">Disconnect</button>
            </div>
        </div>

        <!-- ALERTS -->
        <div id="alertArea" class="alert-area"></div>

        <!-- MAIN GRID -->
        <div class="grid">
            <!-- CREATE GAME CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öîÔ∏è Create Game</div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('create-game', this)">New Game</button>
                    <button class="tab-btn" onclick="switchTab('token-list', this)">Tokens (25)</button>
                </div>

                <!-- CREATE GAME TAB -->
                <div id="create-game" class="tab-content active">
                    <div class="form-group">
                        <label>Game Type</label>
                        <select id="gameType" onchange="updateGamePreview()">
                            <option value="chess">‚ôüÔ∏è Chess</option>
                            <option value="checkers">üî¥ Checkers</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Game Mode</label>
                        <select id="gameMode" onchange="updateGamePreview()">
                            <option value="pvp">üéÆ Player vs Player</option>
                            <option value="ai">ü§ñ vs AI (Future)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Privacy</label>
                        <select id="gamePrivacy">
                            <option value="public">üåç Public</option>
                            <option value="private">üîí Private (Link)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Stake Token</label>
                        <select id="stakeToken" onchange="updateTokenInfo()">
                            <option value="CORE">CORE (Native)</option>
                            <option value="ETH">ETH (Wrapped)</option>
                            <option value="WBTC">WBTC (Wrapped)</option>
                            <option value="USDT">USDT (Wrapped)</option>
                            <option value="BNB">BNB (Wrapped)</option>
                            <option value="SOL">SOL (Wrapped)</option>
                            <option value="XRP">XRP (Wrapped)</option>
                            <option value="ADA">ADA (Wrapped)</option>
                            <option value="AVAX">AVAX (Wrapped)</option>
                            <option value="NEAR">NEAR (Wrapped)</option>
                            <option value="LINK">LINK (Wrapped)</option>
                            <option value="UNI">UNI (Wrapped)</option>
                            <option value="ONDO">ONDO (Wrapped)</option>
                            <option value="FIL">FIL (Wrapped)</option>
                            <option value="INJ">INJ (Wrapped)</option>
                            <option value="AR">AR (Wrapped)</option>
                            <option value="TAO">TAO (Wrapped)</option>
                            <option value="IO">IO (Wrapped)</option>
                            <option value="VIRTUAL">VIRTUAL (Wrapped)</option>
                            <option value="RENDER">RENDER (Wrapped)</option>
                            <option value="HNT">HNT (Wrapped)</option>
                            <option value="MAV">MAV (Wrapped)</option>
                            <option value="ZEC">ZEC (Wrapped)</option>
                            <option value="DOGE">DOGE (Wrapped)</option>
                            <option value="TON">TON (Wrapped)</option>
                            <option value="TRX">TRX (Wrapped)</option>
                            <option value="SHIB">SHIB (Wrapped)</option>
                        </select>
                        <small id="tokenInfo">Native on Core Mainnet</small>
                    </div>

                    <div class="form-group">
                        <label>Stake Amount</label>
                        <input type="number" id="stakeAmount" placeholder="0.1" step="0.01" min="0.01" value="0.1">
                        <small>Min: 0.01 ‚Ä¢ Max: 1000</small>
                    </div>

                    <button onclick="createGame()" style="width:100%">Create Game</button>

                    <div id="shareLinkSection" class="hidden" style="margin-top:15px">
                        <input type="text" id="shareLink" readonly>
                        <button onclick="copyLink()" style="width:100%;margin-top:10px">Copy Invite Link</button>
                    </div>
                </div>

                <!-- TOKEN LIST TAB -->
                <div id="token-list" class="tab-content">
                    <div class="token-list" id="tokenListContainer"></div>
                </div>
            </div>

            <!-- GAME BOARD CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title" id="boardTitle">‚ôüÔ∏è Game Board</div>
                </div>

                <div id="gameNotLoaded" style="text-align:center;padding:40px;color:var(--text-dim)">
                    Create or join a game to play
                </div>

                <div id="gameBoard" class="hidden">
                    <div class="game-info">
                        <div class="game-status" id="gameStatus"></div>
                        <div class="player-info">
                            <div>üë§ <span id="player1Info"></span></div>
                            <div>‚öîÔ∏è <span id="gameStake"></span></div>
                        </div>
                        <div class="player-info">
                            <div>üë§ <span id="player2Info"></span></div>
                            <div id="timerInfo"></div>
                        </div>
                    </div>

                    <div class="game-board" id="chessBoard"></div>

                    <div class="chat-input-group">
                        <input type="text" id="chatInput" placeholder="On-chain message...">
                        <button onclick="sendChatMessage()">Send</button>
                    </div>

                    <div class="chat-window" id="chatWindow"></div>

                    <div style="display:flex;gap:10px">
                        <button onclick="resignGame()" style="flex:1">Resign</button>
                        <button onclick="claimTimeout()" style="flex:1">Claim Win (Timeout)</button>
                    </div>
                </div>
            </div>

            <!-- AVAILABLE GAMES CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ Available Games</div>
                </div>
                <button onclick="loadAvailableGames()" style="width:100%;margin-bottom:15px">Refresh</button>
                <div class="game-list" id="availableGamesList">
                    <p style="text-align:center;color:var(--text-dim)">Connect wallet to see games</p>
                </div>
            </div>

            <!-- MY GAMES CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä My Games</div>
                </div>
                <button onclick="loadMyGames()" style="width:100%;margin-bottom:15px">Refresh My Games</button>
                <div class="game-list" id="myGamesList">
                    <p style="text-align:center;color:var(--text-dim)">Connect wallet to see your games</p>
                </div>
            </div>

            <!-- DASHBOARD CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Dashboard</div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('rewards', this)">Rewards</button>
                    <button class="tab-btn" onclick="switchTab('leaderboard', this)">Leaderboard</button>
                </div>

                <!-- REWARDS TAB -->
                <div id="rewards" class="tab-content active">
                    <div class="tier-display">
                        <div id="tierInfo">Bronze ‚Ä¢ 0 Wins</div>
                    </div>

                    <div class="form-group">
                        <label>Progress to Next Tier</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="tierProgress" style="width:0%"></div>
                        </div>
                        <small id="tierProgress">0/10 wins</small>
                    </div>

                    <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-size:12px">
                        <div style="margin-bottom:10px"><strong>Win Streaks</strong></div>
                        <div id="rewardsInfo">Loading...</div>
                    </div>
                </div>

                <!-- LEADERBOARD TAB -->
                <div id="leaderboard" class="tab-content">
                    <div id="leaderboardList"></div>
                </div>
            </div>

            <!-- SETTINGS CARD -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öôÔ∏è Settings</div>
                </div>

                <div class="form-group">
                    <label>Time Control</label>
                    <select id="timeControl">
                        <option value="bullet">‚ö° Bullet (1 min)</option>
                        <option value="blitz">üî• Blitz (3 min)</option>
                        <option value="rapid" selected>‚è±Ô∏è Rapid (10 min)</option>
                        <option value="classical">üéì Classical (30 min)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sound</label>
                    <select>
                        <option>‚úì Enabled</option>
                        <option>Disabled</option>
                    </select>
                </div>

                <button onclick="downloadStats()" style="width:100%">üì• Download Stats</button>
                
                <div style="margin-top:20px;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:11px;color:var(--text-dim)">
                    <strong>Network:</strong> Core Mainnet (1116)<br>
                    <strong>Version:</strong> 1.0 (Pure On-Chain)<br>
                    <strong>Contracts:</strong> All on-chain, no servers
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FOR GAME DETAILS -->
    <div id="gameDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Game Details</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="footer">
        <div>CrossRealm ¬© 2025 ‚Ä¢ Pure On-Chain on Core Mainnet</div>
        <div style="margin-top:10px">
            <a href="#" class="footer-link">Docs</a>
            <a href="#" class="footer-link">Twitter</a>
            <a href="#" class="footer-link">Discord</a>
            <a href="#" class="footer-link">GitHub</a>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION & STATE ==========
const CORE_MAINNET = {
    chainId: 1116,
    rpcUrl: 'https://rpc.coredao.org',
    blockExplorerUrl: 'https://scan.coredao.org'
};

const TOKEN_CONFIG = {
    CORE:     { name: 'Core DAO', addr: '0x40375c92d9faf44d2f9db9bd9ba41a3317a2404f', decimals: 18, native: true },
    ETH:      { name: 'Ethereum', addr: '0xa4218e1f39da4aadac971066458db56e901bcbde', decimals: 18 },
    WBTC:     { name: 'Bitcoin', addr: '0x5832f53d147b3d6Cd4578B9CBD62425C7ea9d0Bd', decimals: 8 },
    USDT:     { name: 'Tether', addr: '0x900101d06a7426441ae63e9ab3b9b0f63be145f1', decimals: 6 },
    BNB:      { name: 'BNB Chain', addr: '0xdFBc618d3c48e553Cb197F42482A0795bef7fe28', decimals: 18 },
    SOL:      { name: 'Solana', addr: '0x2CAF2E77f47127db14fe74EaA00F0f9aEd44fBd7', decimals: 9 },
    XRP:      { name: 'XRP', addr: '0xa4218e1f39da4aadac971066458db56e901bcbde', decimals: 6 },
    ADA:      { name: 'Cardano', addr: '0xb577E9E300f7337d5f996a2fEc1bb5b8dE1e7d93', decimals: 6 },
    AVAX:     { name: 'Avalanche', addr: '0x', decimals: 18 },
    NEAR:     { name: 'NEAR', addr: '0x', decimals: 24 },
    LINK:     { name: 'Chainlink', addr: '0x', decimals: 18 },
    UNI:      { name: 'Uniswap', addr: '0x', decimals: 18 },
    ONDO:     { name: 'Ondo Finance', addr: '0x', decimals: 18 },
    FIL:      { name: 'Filecoin', addr: '0x', decimals: 18 },
    INJ:      { name: 'Injective', addr: '0x', decimals: 18 },
    AR:       { name: 'Arweave', addr: '0x', decimals: 12 },
    TAO:      { name: 'Bittensor', addr: '0x', decimals: 18 },
    IO:       { name: 'io.net', addr: '0x', decimals: 18 },
    VIRTUAL:  { name: 'Virtuals', addr: '0x', decimals: 18 },
    RENDER:   { name: 'Render', addr: '0x', decimals: 18 },
    HNT:      { name: 'Helium', addr: '0x', decimals: 8 },
    MAV:      { name: 'Maverick', addr: '0x', decimals: 18 },
    ZEC:      { name: 'Zcash', addr: '0x', decimals: 8 },
    DOGE:     { name: 'Dogecoin', addr: '0x', decimals: 8 },
    TON:      { name: 'Toncoin', addr: '0x', decimals: 9 },
    TRX:      { name: 'TRON', addr: '0x', decimals: 6 },
    SHIB:     { name: 'Shiba Inu', addr: '0x', decimals: 18 },
};

// Game contracts (will be set after deployment)
let HUB_ADDRESS = '0x'; // Set after deploy
let REWARDS_ADDRESS = '0x';
let NFT_ADDRESS = '0x';

// State variables
let provider = null;
let signer = null;
let userAddress = null;
let currentGameId = null;
let currentGame = null;
let gameContracts = {};

const ERC20_ABI = [
    'function approve(address spender, uint256 amount) external returns (bool)',
    'function balanceOf(address account) external view returns (uint256)',
    'function transfer(address to, uint256 amount) external returns (bool)',
    'function allowance(address owner, address spender) external view returns (uint256)'
];

// ========== WALLET MANAGEMENT ==========
async function connectWallet() {
    if (!window.ethereum) {
        showAlert('MetaMask not installed. Install it to play!', 'error');
        return;
    }

    try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        // Setup provider and signer
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        // Check network
        const network = await provider.getNetwork();
        if (network.chainId !== CORE_MAINNET.chainId) {
            await switchToCoreNetwork();
        }

        updateWalletUI();
        loadAvailableGames();
        loadMyGames();
        loadDashboard();
        showAlert(`Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`, 'success');
    } catch (error) {
        showAlert(`Connection failed: ${error.message}`, 'error');
    }
}

async function switchToCoreNetwork() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x' + CORE_MAINNET.chainId.toString(16) }],
        });
    } catch (error) {
        if (error.code === 4902) {
            await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                    chainId: '0x' + CORE_MAINNET.chainId.toString(16),
                    chainName: 'Core Blockchain',
                    rpcUrls: [CORE_MAINNET.rpcUrl],
                    blockExplorerUrls: [CORE_MAINNET.blockExplorerUrl],
                    nativeCurrency: { name: 'CORE', symbol: 'CORE', decimals: 18 }
                }],
            });
        }
    }
}

function disconnectWallet() {
    userAddress = null;
    provider = null;
    signer = null;
    currentGameId = null;
    updateWalletUI();
    showAlert('Wallet disconnected', 'info');
}

function updateWalletUI() {
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const networkStatus = document.getElementById('networkStatus');
    const walletAddress = document.getElementById('walletAddress');

    if (userAddress) {
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'block';
        networkStatus.textContent = 'üü¢ Connected';
        walletAddress.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
    } else {
        connectBtn.style.display = 'block';
        disconnectBtn.style.display = 'none';
        networkStatus.textContent = 'üî¥ Disconnected';
        walletAddress.textContent = '';
    }
}

// ========== ALERTS ==========
function showAlert(message, type = 'success') {
    const alertArea = document.getElementById('alertArea');
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.innerHTML = message;
    alertArea.appendChild(alert);

    setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transition = 'opacity 0.3s';
        setTimeout(() => alert.remove(), 300);
    }, 5000);
}

// ========== TAB SWITCHING ==========
function switchTab(tabName, btn) {
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(t => t.classList.remove('active'));
    document.getElementById(tabName)?.classList.add('active');

    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    if (tabName === 'token-list') {
        populateTokenList();
    } else if (tabName === 'leaderboard') {
        loadLeaderboard();
    }
}

// ========== TOKEN MANAGEMENT ==========
function populateTokenList() {
    const container = document.getElementById('tokenListContainer');
    container.innerHTML = '';

    Object.entries(TOKEN_CONFIG).forEach(([symbol, config]) => {
        const item = document.createElement('div');
        item.className = 'token-item';
        item.innerHTML = `
            <div>
                <div class="token-symbol">${symbol}</div>
                <div class="token-chain">${config.name}</div>
            </div>
            <div style="text-align:right;font-size:10px">
                ${config.native ? '‚úì Native' : 'üåâ Wrapped'}
            </div>
        `;
        container.appendChild(item);
    });
}

function updateTokenInfo() {
    const token = document.getElementById('stakeToken').value;
    const config = TOKEN_CONFIG[token];
    const infoEl = document.getElementById('tokenInfo');

    if (config.native) {
        infoEl.textContent = '‚úì Native on Core Mainnet';
        infoEl.style.color = '#10b981';
    } else {
        infoEl.textContent = 'üåâ Wrapped token via LayerZero';
        infoEl.style.color = '#f59e0b';
    }
}

// ========== GAME MANAGEMENT ==========
function updateGamePreview() {
    const gameType = document.getElementById('gameType').value;
    const title = document.getElementById('boardTitle');
    title.textContent = gameType === 'chess' ? '‚ôüÔ∏è Chess Board' : 'üî¥ Checkers Board';
}

async function createGame() {
    if (!userAddress) {
        showAlert('Connect wallet first', 'error');
        return;
    }

    const gameType = document.getElementById('gameType').value;
    const stake = document.getElementById('stakeAmount').value;
    const token = document.getElementById('stakeToken').value;
    const privacy = document.getElementById('gamePrivacy').value;
    const config = TOKEN_CONFIG[token];

    if (!stake || parseFloat(stake) < 0.01) {
        showAlert('Minimum stake is 0.01', 'error');
        return;
    }

    try {
        showAlert('Creating game on Core Mainnet...', 'info');

        // Simulate game creation (real implementation will call smart contract)
        const gameId = Math.floor(Math.random() * 1000000);
        currentGameId = gameId;

        const gameData = {
            id: gameId,
            creator: userAddress,
            player2: null,
            gameType: gameType,
            stake: stake,
            token: token,
            privacy: privacy,
            status: 'waiting',
            moves: [],
            createdAt: new Date().toISOString(),
            timeControl: document.getElementById('timeControl').value
        };

        // Store game locally for now (will be on-chain)
        localStorage.setItem(`game_${gameId}`, JSON.stringify(gameData));

        showAlert(`Game created! ID: ${gameId} | Stake: ${stake} ${token}`, 'success');

        if (privacy === 'private') {
            const link = `${window.location.origin}?gameId=${gameId}`;
            document.getElementById('shareLink').value = link;
            document.getElementById('shareLinkSection').classList.remove('hidden');
        }

        // Load the game board
        loadGame(gameId);
        loadAvailableGames();
    } catch (error) {
        showAlert(`Game creation failed: ${error.message}`, 'error');
    }
}

function copyLink() {
    const link = document.getElementById('shareLink');
    link.select();
    document.execCommand('copy');
    showAlert('Link copied to clipboard!', 'success');
}

async function loadGame(gameId) {
    try {
        const gameJson = localStorage.getItem(`game_${gameId}`);
        if (!gameJson) {
            showAlert('Game not found', 'error');
            return;
        }

        currentGame = JSON.parse(gameJson);
        currentGameId = gameId;

        // Hide creation section, show game board
        document.getElementById('gameNotLoaded').classList.add('hidden');
        document.getElementById('gameBoard').classList.remove('hidden');

        // Update game info
        document.getElementById('gameStatus').textContent = `Game ${gameId} ‚Ä¢ ${currentGame.gameType.toUpperCase()}`;
        document.getElementById('player1Info').textContent = `${currentGame.creator.slice(0, 6)}... (You)`;
        document.getElementById('player2Info').textContent = currentGame.player2 ? `${currentGame.player2.slice(0, 6)}...` : 'Waiting...';
        document.getElementById('gameStake').textContent = `${currentGame.stake} ${currentGame.token}`;

        // Render board
        renderChessBoard();
    } catch (error) {
        showAlert(`Load failed: ${error.message}`, 'error');
    }
}

function renderChessBoard() {
    const board = document.getElementById('chessBoard');
    board.innerHTML = '';

    for (let i = 0; i < 64; i++) {
        const square = document.createElement('div');
        const row = Math.floor(i / 8);
        const col = i % 8;
        const isWhite = (row + col) % 2 === 0;

        square.className = `square ${isWhite ? 'white' : ''}`;
        square.dataset.index = i;
        square.onclick = () => selectSquare(i);

        // Add piece placeholder
        if (i === 0 || i === 7) square.textContent = '‚ôú';
        if (i === 1 || i === 6) square.textContent = '‚ôò';
        if (i === 2 || i === 5) square.textContent = '‚ôó';
        if (i === 3) square.textContent = '‚ôï';
        if (i === 4) square.textContent = '‚ôî';
        if (i >= 8 && i <= 15) square.textContent = '‚ôü';

        board.appendChild(square);
    }
}

function selectSquare(index) {
    const squares = document.querySelectorAll('.square');
    squares.forEach(s => s.classList.remove('selected'));
    squares[index].classList.add('selected');

    // This will be expanded with actual move logic
    console.log(`Selected square ${index}`);
}

async function joinGame(gameId) {
    if (!userAddress) {
        showAlert('Connect wallet first', 'error');
        return;
    }

    try {
        const gameJson = localStorage.getItem(`game_${gameId}`);
        if (!gameJson) {
            showAlert('Game not found', 'error');
            return;
        }

        const game = JSON.parse(gameJson);
        if (game.creator === userAddress) {
            showAlert('Cannot join your own game', 'error');
            return;
        }

        game.player2 = userAddress;
        game.status = 'active';
        localStorage.setItem(`game_${gameId}`, JSON.stringify(game));

        showAlert('Game joined! Starting...', 'success');
        loadGame(gameId);
        loadAvailableGames();
    } catch (error) {
        showAlert(`Failed to join: ${error.message}`, 'error');
    }
}

async function loadAvailableGames() {
    if (!userAddress) return;

    try {
        const gamesList = document.getElementById('availableGamesList');
        gamesList.innerHTML = '<div class="loading" style="margin:20px"></div>';

        // Simulate loading games
        const games = [];
        for (let i = 0; i < Math.max(1, Math.random() * 5); i++) {
            games.push({
                id: Math.floor(Math.random() * 1000000),
                creator: '0x' + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join(''),
                gameType: Math.random() > 0.5 ? 'chess' : 'checkers',
                stake: (Math.random() * 10 + 0.1).toFixed(2),
                token: 'CORE'
            });
        }

        gamesList.innerHTML = '';

        if (games.length === 0) {
            gamesList.innerHTML = '<p style="text-align:center;color:var(--text-dim)">No games available. Create one!</p>';
            return;
        }

        games.forEach(game => {
            const item = document.createElement('div');
            item.className = 'game-item';
            item.innerHTML = `
                <div>
                    <strong>${game.gameType.toUpperCase()}</strong><br>
                    ${game.creator.slice(0, 8)}... ‚Ä¢ Stake: ${game.stake} ${game.token}
                </div>
                <button onclick="joinGame(${game.id})" style="margin:0">Join</button>
            `;
            gamesList.appendChild(item);
        });
    } catch (error) {
        document.getElementById('availableGamesList').innerHTML = `<p style="color:var(--error)">${error.message}</p>`;
    }
}

async function loadMyGames() {
    if (!userAddress) return;

    try {
        const gamesList = document.getElementById('myGamesList');
        
        // Get all games from localStorage
        const games = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('game_')) {
                const game = JSON.parse(localStorage.getItem(key));
                if (game.creator === userAddress || game.player2 === userAddress) {
                    games.push(game);
                }
            }
        }

        gamesList.innerHTML = '';

        if (games.length === 0) {
            gamesList.innerHTML = '<p style="text-align:center;color:var(--text-dim)">No active games</p>';
            return;
        }

        games.forEach(game => {
            const item = document.createElement('div');
            item.className = 'game-item';
            const isCreator = game.creator === userAddress;
            const otherPlayer = isCreator ? game.player2 : game.creator;

            item.innerHTML = `
                <div>
                    <strong>${game.gameType.toUpperCase()}</strong> ‚Ä¢ ${game.status.toUpperCase()}<br>
                    vs ${otherPlayer ? otherPlayer.slice(0, 8) + '...' : 'Waiting...'}
                    <br><small>Stake: ${game.stake} ${game.token}</small>
                </div>
                <button onclick="loadGame(${game.id})" style="margin:0">Play</button>
            `;
            gamesList.appendChild(item);
        });
    } catch (error) {
        console.error(error);
    }
}

async function resignGame() {
    if (!currentGameId) return;

    try {
        showAlert('Game resigned. You lost this round.', 'warning');
        const game = JSON.parse(localStorage.getItem(`game_${currentGameId}`));
        game.status = 'resigned';
        localStorage.setItem(`game_${currentGameId}`, JSON.stringify(game));

        currentGameId = null;
        document.getElementById('gameBoard').classList.add('hidden');
        document.getElementById('gameNotLoaded').classList.remove('hidden');
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function claimTimeout() {
    if (!currentGameId) return;
    showAlert('Timeout claimed! You won by timeout.', 'success');
    // Will record win on-chain
}

// ========== CHAT SYSTEM (ON-CHAIN) ==========
async function sendChatMessage() {
    if (!userAddress || !currentGameId) return;

    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    try {
        // Message will be stored on-chain in the game contract
        const chatWindow = document.getElementById('chatWindow');
        const msg = document.createElement('div');
        msg.className = 'chat-message';
        msg.innerHTML = `<strong>You:</strong> ${message}`;
        chatWindow.appendChild(msg);

        input.value = '';
        chatWindow.scrollTop = chatWindow.scrollHeight;

        // Here we would call the contract to record the message
        showAlert('Message sent on-chain', 'success');
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// ========== DASHBOARD & REWARDS ==========
async function loadDashboard() {
    if (!userAddress) return;

    try {
        const wins = Math.floor(Math.random() * 50);
        const losses = Math.floor(Math.random() * 30);
        const streak = Math.floor(Math.random() * 10);

        document.getElementById('tierInfo').textContent = `${getTierName(wins)} ‚Ä¢ ${wins} Wins`;
        document.getElementById('tierProgress').style.width = `${(wins % 10) * 10}%`;
        document.getElementById('rewardsInfo').innerHTML = `
            <div><strong>Wins:</strong> ${wins}</div>
            <div><strong>Losses:</strong> ${losses}</div>
            <div><strong>Win Streak:</strong> ${streak}</div>
            <div style="margin-top:10px;color:var(--success)"><strong>Claimable:</strong> ${(wins * 0.1).toFixed(2)} CORE</strong></div>
        `;
    } catch (error) {
        console.error(error);
    }
}

function getTierName(wins) {
    if (wins >= 100) return 'üèÜ Legendary';
    if (wins >= 50) return 'üíé Diamond';
    if (wins >= 25) return 'ü•á Gold';
    if (wins >= 10) return 'ü•à Silver';
    if (wins >= 5) return 'ü•â Bronze';
    return '‚≠ê Novice';
}

async function loadLeaderboard() {
    try {
        const leaderboard = document.getElementById('leaderboardList');
        leaderboard.innerHTML = '';

        const leaders = [
            { rank: 1, name: '@ChessMaster', elo: 2850, wins: 147 },
            { rank: 2, name: '@CoreKing', elo: 2720, wins: 132 },
            { rank: 3, name: '@CheckersQueen', elo: 2650, wins: 118 },
            { rank: 4, name: '@OnChainViper', elo: 2580, wins: 95 },
            { rank: 5, name: '@BlockchainGamer', elo: 2520, wins: 87 },
        ];

        leaders.forEach(leader => {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            item.innerHTML = `
                <div class="rank-badge">#${leader.rank}</div>
                <div style="flex:1">
                    <div><strong>${leader.name}</strong></div>
                    <div style="font-size:11px;color:var(--text-dim)">${leader.wins} wins</div>
                </div>
                <div style="text-align:right">
                    <div style="color:var(--accent);font-weight:bold">${leader.elo}</div>
                    <div style="font-size:11px;color:var(--text-dim)">ELO</div>
                </div>
            `;
            leaderboard.appendChild(item);
        });
    } catch (error) {
        console.error(error);
    }
}

function downloadStats() {
    const stats = {
        wallet: userAddress,
        exportedAt: new Date().toISOString(),
        games: [],
        totalWins: 0,
        totalLosses: 0
    };

    // Gather game data
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('game_')) {
            const game = JSON.parse(localStorage.getItem(key));
            if (game.creator === userAddress || game.player2 === userAddress) {
                stats.games.push(game);
            }
        }
    }

    const dataStr = JSON.stringify(stats, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `crossrealm-stats-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    showAlert('Stats downloaded!', 'success');
}

// ========== MODAL ==========
function closeModal() {
    document.getElementById('gameDetailModal').classList.remove('active');
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
    populateTokenList();
    updateTokenInfo();
    updateGamePreview();

    // Listen for wallet changes
    if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== userAddress) {
                connectWallet();
            }
        });

        window.ethereum.on('chainChanged', () => {
            location.reload();
        });
    }
});
