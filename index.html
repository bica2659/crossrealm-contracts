<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>CrossRealm • On-Chain Checkers & Chess on Core</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- For analytics charts -->
    <script src="https://cdn.jsdelivr.net/npm/stockfish@16.0.0/stockfish.js"></script> <!-- For AI opponents -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> <!-- For in-game chat -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script> <!-- For chess logic -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQ3Jvc3NSZWalmIiwic2hvcnRfbmFtZSI6IkNSUiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5IjoiZnVsbHNjcmVlbiIsImJhY2tncm91bmRfY29sb3IiOiIjMGYwZjBmIiwidGhlbWVfY29sb3IiOiIjZjc5MzFhIn0="> <!-- PWA manifest placeholder -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --bitcoin-orange: #f7931a;
            --burnt-orange: #cc6600;
            --core-green: #00ff88;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #999;
            --success: var(--core-green);
            --error: #ff4444;
            --gradient-primary: linear-gradient(135deg, var(--bitcoin-orange), var(--burnt-orange));
            --gradient-success: linear-gradient(135deg, var(--core-green), #00cc6a);
            --wood-bg: linear-gradient(135deg, #D2B48C 0%, #8B4513 50%, #A0522D 100%);
            --wood-light: #DEB887;
            --wood-dark: #8B4513;
            --piece-black: #000;
            --piece-red: #8B0000;
            --highlight-selected: #4169E1; /* Blue */
            --highlight-possible: #FFD700; /* Yellow */
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(247, 147, 26, 0.03) 2px, rgba(247, 147, 26, 0.03) 4px);
            overflow-x: hidden;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        /* Header */
        .header {
            background: var(--card-bg);
            border: 2px solid var(--bitcoin-orange);
            border-radius: 0;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(247, 147, 26, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--bitcoin-orange);
            margin-bottom: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
            text-align: center;
        }
        .tagline {
            color: var(--text-dim);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            z-index: 1;
            text-align: center;
        }
        .wallet-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        .wallet-status {
            font-size: 11px;
            color: var(--text-dim);
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        .wallet-address {
            color: var(--bitcoin-orange);
            font-weight: bold;
        }
        /* Buttons */
        button {
            background: var(--gradient-primary);
            color: #000;
            border: none;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            line-height: 1.2;
            border-radius: 4px;
        }
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        button:hover::before, button:active::before {
            width: 300px;
            height: 300px;
        }
        button:hover, button:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--core-green);
        }
        button:disabled {
            background: var(--border);
            color: var(--text-dim);
            cursor: not-allowed;
            opacity: 0.5;
        }
        button:disabled:hover, button:active:disabled {
            transform: none;
            box-shadow: none;
        }
        .disconnect-btn, .resign-btn {
            background: var(--gradient-primary);
            color: #000;
            text-shadow: 0 0 5px rgba(255, 68, 68, 0.8);
        }
        .claim-btn, .claim-reward-btn, .claim-dev-btn, .claim-multi-btn, .farm-btn {
            background: var(--gradient-success);
            color: #000;
            margin-top: 10px;
        }
        .copy-btn, .share-btn {
            background: var(--gradient-success);
            color: #000;
            padding: 8px 12px;
            font-size: 12px;
            margin-left: 10px;
            min-height: 40px;
        }
        .nft-btn, .tournament-btn, .ai-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e); /* Gold for NFTs/Tourneys */
            color: #000;
            margin: 5px;
        }
        .bridge-btn {
            background: linear-gradient(135deg, #000000, #333333); /* BTC-inspired */
            color: #f7931a;
            border: 1px solid var(--bitcoin-orange);
        }
        .dev-panel-btn {
            background: var(--gradient-primary);
            color: #000;
            width: 100%;
            margin-top: 10px;
        }
        .join-btn, .move-btn {
            background: var(--gradient-success);
            color: #000;
            padding: 8px 12px;
            font-size: 12px;
            margin: 5px;
        }
        .equip-nft-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 8px 12px;
            font-size: 12px;
            margin: 5px;
        }
        .zero-gas-toggle {
            background: var(--gradient-success);
            color: #000;
            padding: 5px 10px;
            font-size: 10px;
        }
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (min-width: 769px) {
            .grid {
                grid-template-columns: 350px 1fr 350px;
                gap: 20px;
            }
        }
        @media (min-width: 1201px) {
            .grid {
                grid-template-columns: 400px 1fr 400px;
                gap: 20px;
            }
        }
        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .card-header {
            border-bottom: 2px solid var(--bitcoin-orange);
            padding-bottom: 12px;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--bitcoin-orange);
        }
        /* Tabs for new sections */
        .tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: var(--border);
            color: var(--text-dim);
            border: none;
            cursor: pointer;
        }
        .tab-btn.active {
            background: var(--bitcoin-orange);
            color: #000;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Dev Panel */
        #devPanel {
            background: linear-gradient(135deg, var(--card-bg), rgba(247, 147, 26, 0.1));
            border: 2px solid var(--bitcoin-orange);
        }
        #devPanel .card-title {
            color: var(--success);
        }
        .dev-tx-list, .dev-month-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .dev-tx-item, .dev-month-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .dev-tx-hash, .dev-month-check {
            color: var(--bitcoin-orange);
            font-family: monospace;
            word-break: break-all;
            cursor: pointer;
        }
        .dev-tx-hash:hover, .dev-month-check:hover {
            text-decoration: underline;
        }
        .dev-month-selector {
            margin-bottom: 15px;
        }
        .dev-chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }
        /* Form elements */
        .game-selector, .token-selector, .privacy-selector, .nft-selector {
            margin-bottom: 15px;
        }
        .game-selector select, .token-selector select, .privacy-selector select, .nft-selector select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px;
            width: 100%;
            border-radius: 4px;
        }
        /* Game Board - Styled like Checkers365 */
        .game-board-container {
            position: relative;
            margin: 20px auto;
            max-width: 400px;
            background: var(--wood-bg);
            border: 10px solid #8B4513;
            border-radius: 10px;
            padding: 10px;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            background: var(--wood-dark);
            padding: 4px;
        }
        .board-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .board-labels.vertical {
            flex-direction: column;
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
        }
        .square {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            border-radius: 50%;
            position: relative;
        }
        .square.light { 
            background: var(--wood-light); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .square.dark { 
            background: var(--wood-dark); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .square.selected { 
            background: var(--highlight-selected) !important; 
            box-shadow: 0 0 10px var(--highlight-selected);
        }
        .square.possible { 
            background: var(--highlight-possible) !important; 
            box-shadow: 0 0 10px var(--highlight-possible);
        }
        .piece { 
            width: 80%;
            height: 80%;
            border-radius: 50%;
            background: var(--piece-black);
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .piece.red { background: var(--piece-red); }
        .hidden { display: none; }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .alert.success { background: rgba(0,255,136,0.1); color: var(--success); }
        .alert.error { background: rgba(255,68,68,0.1); color: var(--error); }
        .loading { text-align: center; color: var(--text-dim); }
        .share-link-section { margin-top: 15px; }
        .share-link-section input { width: 100%; padding: 10px; background: var(--border); color: var(--text); border: 1px solid var(--bitcoin-orange); }
        .chat-window { max-height: 200px; overflow-y: auto; background: var(--border); padding: 10px; border-radius: 4px; margin-top: 10px; }
        .chat-message { margin-bottom: 5px; font-size: 12px; }
        #gameBoard { margin: 20px auto; }
        #replayBoard { margin: 20px auto; }
        .game-controls { text-align: center; margin: 10px 0; }
        .leaderboard-item, .tournament-item, .game-item { padding: 10px; border: 1px solid var(--border); margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .rank-badge { background: var(--bitcoin-orange); color: #000; padding: 5px 10px; border-radius: 50%; font-weight: bold; }
        .tier-bar { background: var(--border); height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .tier-progress { height: 100%; background: var(--gradient-success); transition: width 0.3s; }
        .games-list { max-height: 300px; overflow-y: auto; }
        .nft-list { max-height: 150px; overflow-y: auto; }
        .nft-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border: 1px solid var(--border); margin-bottom: 5px; border-radius: 4px; }
        .player-indicator {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }
        .player-bar {
            background: rgba(0,0,0,0.3);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            flex: 1;
            margin: 0 10px;
        }
        .player-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--core-green), var(--bitcoin-orange));
            transition: width 0.3s;
        }
        .settings-gear {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .game-board-container { max-width: 300px; }
            .square { font-size: 24px; }
            .piece { width: 70%; height: 70%; }
            .board-labels { font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">CrossRealm</h1>
            <p class="tagline">On-Chain Checkers & Chess on Core</p>
            <div class="wallet-bar">
                <div id="walletStatus" class="wallet-status">
                    <span id="walletAddress">Not Connected</span>
                </div>
                <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectWallet()" style="display:none;">Disconnect</button>
            </div>
        </header>

        <div id="alertArea" class="alert-area"></div>

        <div class="grid">
            <!-- Left Sidebar: Create & Dashboard -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Create Game</h3>
                </div>
                <div class="game-selector">
                    <label>Game Type</label>
                    <select id="gameType" onchange="updateCreateButton()">
                        <option value="chess">Chess</option>
                        <option value="checkers">Checkers</option>
                    </select>
                </div>
                <div class="token-selector">
                    <label>Stake Token</label>
                    <select id="stakeToken" onchange="updateCreateButton()"></select>
                </div>
                <div class="form-group">
                    <label>Stake Amount (Min: 1 USDT equiv, Max: 1000 USDT equiv)</label>
                    <input type="number" id="stakeAmount" placeholder="1" step="0.01" min="0.01" onchange="updateCreateButton()">
                    <small id="stakeLimits"></small>
                </div>
                <div class="privacy-selector">
                    <label>Privacy</label>
                    <select id="privacy" onchange="updateCreateButton()">
                        <option value="public">Public</option>
                        <option value="closed">Invite-Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Referral (Optional)</label>
                    <input type="text" id="referral" placeholder="0x...">
                </div>
                <label><input type="checkbox" id="aiMode" onchange="toggleAI()"> Play vs AI</label>
                <label><input type="checkbox" id="zeroGasMode" onchange="updateCreateButton()" class="zero-gas-toggle"> Zero-Gas Mode (Sponsored)</label>
                <button id="createBtn" onclick="createGame()" disabled>Create Game</button>
                <button id="bridgeBtn" class="bridge-btn" onclick="bridgeTokens()" style="display:none;">Bridge Token</button>
                <div class="share-link-section hidden" id="shareLinkSection">
                    <label>Share Link</label>
                    <input type="text" id="shareLink" readonly>
                    <button class="copy-btn" onclick="copyShareLink()">Copy</button>
                    <button class="share-btn" onclick="shareToSocial()">Share</button>
                </div>

                <div class="card-header" style="margin-top:20px;">
                    <h3 class="card-title">Dashboard</h3>
                </div>
                <div id="dashboard">
                    <div id="tierInfo" style="font-weight:bold;margin-bottom:5px;"></div>
                    <div class="tier-bar"><div id="tierProgress" class="tier-progress"></div></div>
                    <div id="rewardsInfo"></div>
                    <button class="claim-btn" onclick="claimRewards()">Claim Rewards</button>
                </div>

                <div class="card-header" style="margin-top:20px;">
                    <h3 class="card-title">NFTs</h3>
                </div>
                <div id="nftSection">
                    <div class="loading">Connect wallet to load NFTs</div>
                    <button class="equip-nft-btn" onclick="equipNFT()" disabled>Equip NFT</button>
                </div>
            </div>

            <!-- Center: Games List & Game Board -->
            <div class="card">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('pending')">Pending Games</button>
                    <button class="tab-btn" onclick="switchTab('active')">Active Game</button>
                </div>
                <div id="pendingTab" class="tab-content active">
                    <div class="games-list" id="pendingGamesList">
                        <div class="loading">Loading pending games...</div>
                    </div>
                    <button class="tournament-btn" onclick="loadPendingGames()">Refresh</button>
                </div>
                <div id="activeTab" class="tab-content">
                    <div id="gameNotLoaded" class="loading">No game loaded. Create or join one!</div>
                    <div id="gameBoard" class="hidden">
                        <div class="settings-gear" onclick="toggleSettings()">⚙️</div>
                        <div class="player-indicator">
                            <div id="cpuIndicator">
                                <span>CPU</span>
                                <div class="player-bar"><div class="player-progress" id="cpuProgress" style="width:77%"></div></div>
                                <span id="cpuPercent">77.2%</span>
                            </div>
                            <div id="playerIndicator">
                                <span>Player</span>
                                <div class="player-bar"><div class="player-progress" id="playerProgress" style="width:23%"></div></div>
                                <span id="playerPercent">22.8%</span>
                            </div>
                        </div>
                        <div class="game-board-container">
                            <div class="board-labels vertical" id="rowLabels">10<br>9<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1</div>
                            <div id="board" class="game-board"></div>
                            <div class="board-labels" id="colLabels">A B C D E F G H</div>
                        </div>
                        <div class="game-controls">
                            <button class="move-btn" id="makeMoveBtn" onclick="makeMove()" disabled>Make Move</button>
                            <button class="resign-btn" onclick="resignGame()">Resign</button>
                            <button onclick="claimTimeout()">Claim Timeout</button>
                        </div>
                        <div>
                            <input type="text" id="chatInput" placeholder="Chat (on-chain)" style="width:70%;margin-right:5px;">
                            <button onclick="sendChatMessage()">Send</button>
                        </div>
                        <div id="chatWindow" class="chat-window"></div>
                    </div>
                </div>
                <div id="replaySection" class="hidden">
                    <button onclick="openReplay()">Open Replay</button>
                    <div id="replayBoard" class="game-board"></div>
                    <button onclick="closeReplay()">Close Replay</button>
                </div>
            </div>

            <!-- Right Sidebar: Leaderboard & Tournaments -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Leaderboard</h3>
                </div>
                <div id="leaderboard">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Tournaments</h3>
                </div>
                <button class="tournament-btn" onclick="createTournament()">Create Tournament</button>
                <div id="tournaments">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Dev Panel (Hidden by default) -->
        <div id="devPanel" class="card hidden">
            <div class="card-header">
                <h3 class="card-title">Dev Panel - Usage Analytics</h3>
            </div>
            <button class="dev-panel-btn" onclick="loadDevPanel()">Refresh Analytics</button>
            <div class="dev-month-selector">
                <label>Select Month</label>
                <select id="monthSelector" onchange="loadDevPanel()"></select>
            </div>
            <div id="devTxList" class="dev-tx-list"></div>
            <div id="devMonthList" class="dev-month-list"></div>
            <div class="dev-chart-container">
                <canvas id="devChart"></canvas> <!-- Stakes & Games -->
            </div>
            <div class="dev-chart-container">
                <canvas id="usageChart"></canvas> <!-- Users & Engagement -->
            </div>
            <button class="claim-dev-btn" onclick="claimDevShare()">Claim Dev Share</button>
            <button class="claim-multi-btn" onclick="claimMultiDevShare()">Claim Multi-Dev</button>
        </div>
    </div>

    <script>
        // Configuration
        const HUB_ADDRESS = '0x2F5B0Ea92dc8Dec0284486d2De0F97734c758855';
        const REWARDS_ADDRESS = '0x91A7270688C6E94Ad8BA930BEF03220D5429C318';
        const NFT_ADDRESS = '0xDb098B32e1d73b69676CFB6144B553FE27d99B44';
        const LAYERZERO_ENDPOINT = '0x9740FF91F1985D8d2B71494aE1A2f723bb3Ed9E4';
        // Chainlink Aggregator for USDT equiv (WBTC/USD, CORE/USD etc.)
        const CHAINLINK_AGGREGATOR = '0x...'; // e.g., WBTC/USD on Core: Fetch from Chainlink docs
        const EXPLORER_URL = 'https://scan.coredao.org/tx/';
        const baseUrl = window.location.origin + window.location.pathname;
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        // Pimlico Bundler for Zero-Gas (EIP-4337)
        const BUNDLER_URL = 'https://api.pimlico.io/v1/core/rpc'; // Pimlico for Core
        const PAYMASTER_URL = 'https://api.pimlico.io/v1/core/rpc/4337/paymaster'; // Sponsored paymaster
        let userAddress = null;
        let selectedGameType = 'chess';
        let currentGamePrivacy = 'public';
        let currentReferral = null;
        let aiMode = false;
        let zeroGasMode = false;
        let currentGameId = null;
        let currentGame = null;
        let chess = null; // For chess
        let checkersBoard = null; // For checkers (simple array)
        let devChart = null;
        let usageChart = null;
        let selectedSquare = null;
        let tokenPrices = {}; // Cache prices from Chainlink

        // ABIs (extended)
        const HUB_ABI = [...]; // Same as before
        const REWARDS_ABI = [...]; // Same
        const NFT_ABI = [...]; // Same
        const ERC20_ABI = [...]; // Same + decimals
        const CHAINLINK_ABI = [
            "function latestRoundData() external view returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)"
        ];
        const LZ_ABI = [...]; // Same

        // Tokens (same as before)
        const TOP_TOKENS = [...]; // Same

        let selectedToken = 'CORE';

        // Zero-Gas Helper (EIP-4337 via Pimlico)
        async function sendZeroGasTx(contract, method, params, value = 0) {
            if (!zeroGasMode) return contract[method](...params, { value });
            try {
                const bundlerProvider = new ethers.providers.JsonRpcProvider(BUNDLER_URL);
                // Simplified UserOp - full impl: https://docs.pimlico.io/
                const userOp = {
                    sender: userAddress,
                    nonce: await provider.getTransactionCount(userAddress, 'pending'),
                    callData: contract.interface.encodeFunctionData(method, params),
                    callGasLimit: 1000000,
                    // Paymaster sponsors gas
                };
                const paymasterAndData = await (await fetch(PAYMASTER_URL, { method: 'POST', body: JSON.stringify({ userOp }), headers: {'Content-Type': 'application/json'} })).json();
                userOp.paymasterAndData = paymasterAndData;
                // Bundle and send
                const bundle = await (await fetch(`${BUNDLER_URL}/sendUserOperation`, { method: 'POST', body: JSON.stringify({ userOp }), headers: {'Content-Type': 'application/json'} })).json();
                return bundle.userOpHash;
            } catch (error) {
                showAlert('Zero-gas failed, falling back: ' + error.message, 'warning');
                return contract[method](...params, { value });
            }
        }

        // Dynamic Stake Limits via Chainlink
        async function updateStakeLimits() {
            try {
                const aggregator = new ethers.Contract(CHAINLINK_AGGREGATOR, CHAINLINK_ABI, provider);
                const roundData = await aggregator.latestRoundData();
                const usdPrice = roundData.answer / 1e8; // WBTC/USD example
                const tokenInfo = TOP_TOKENS.find(t => t.symbol === selectedToken);
                const minStake = ethers.utils.parseUnits('1', tokenInfo.decimals).div(usdPrice.toString()); // 1 USDT equiv
                const maxStake = minStake.mul(1000); // Max 1000 USDT
                document.getElementById('stakeLimits').textContent = `Min: ${ethers.utils.formatUnits(minStake, tokenInfo.decimals)} ${tokenInfo.symbol}`;
                document.getElementById('stakeAmount').min = ethers.utils.formatUnits(minStake, tokenInfo.decimals);
            } catch (error) {
                console.error('Price fetch failed', error);
            }
        }

        // Init (add price update)
        function initTokenSelect() {
            // Same as before
            updateStakeLimits(); // Call on change
        }

        document.getElementById('stakeToken').addEventListener('change', (e) => {
            selectedToken = e.target.value;
            updateStakeLimits();
            updateCreateButton();
        });

        // Game Creation (use zero-gas)
        async function createGame() {
            // Validation with dynamic min
            const stakeAmount = parseFloat(document.getElementById('stakeAmount').value) || 0;
            if (stakeAmount < parseFloat(document.getElementById('stakeAmount').min)) return showAlert('Below min stake', 'error');
            // Rest same, but wrap tx in sendZeroGasTx(hub, 'createGame', [params])
            const hub = new ethers.Contract(HUB_ADDRESS, HUB_ABI, signer);
            const tx = await sendZeroGasTx(hub, 'createGame', [selectedGameType, netStake, tokenAddr, currentGamePrivacy === 'closed', currentReferral, aiMode, zeroGasMode], value);
            // Wait and parse
        }

        // Board Render (Checkers365 style - for checkers: 8x8, circular pieces, highlights)
        function renderBoard(fen) {
            const board = document.getElementById('board');
            board.innerHTML = '';
            if (selectedGameType === 'chess') {
                // Chess logic same
                chess = new Chess(fen);
                // Render squares/pieces as before, but adapt pieces to Unicode
            } else { // Checkers
                // Simple 8x8 checkers board state (mock initial)
                const initialCheckers = [
                    // Row 1-3 black pieces, etc. - implement full
                    ['', '', 'b', '', 'b', '', 'b', ''],
                    // ...
                ];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        square.className = `square ${(row + col) % 2 ? 'dark' : 'light'}`;
                        const piece = initialCheckers[row][col];
                        if (piece) {
                            const pieceEl = document.createElement('div');
                            pieceEl.className = `piece ${piece === 'b' ? '' : 'red'}`;
                            square.appendChild(pieceEl);
                        }
                        square.onclick = (e) => selectSquare(row * 8 + col, e);
                        board.appendChild(square);
                    }
                }
                // Add highlights for possible moves (yellow), selected (blue)
            }
            // Update progress bars (mock CPU 77%, Player 23%)
            document.getElementById('cpuProgress').style.width = '77%';
            document.getElementById('playerProgress').style.width = '23%';
        }

        function selectSquare(index, event) {
            // Highlight selected (blue), possibles (yellow)
            document.querySelectorAll('.square').forEach(s => {
                s.classList.remove('selected', 'possible');
            });
            event.target.classList.add('selected');
            // Mock possibles
            // [...].forEach(p => p.classList.add('possible'));
            selectedSquare = index;
            document.getElementById('makeMoveBtn').disabled = false;
        }

        // Dev Panel (Enhanced Usage Charts)
        async function loadDevPanel() {
            if (!isDev()) return;
            document.getElementById('devPanel').classList.remove('hidden');
            try {
                // Fetch events for unique users, stakes, games
                const filter = hub.filters.GameCreated();
                const events = await hub.queryFilter(filter, -10000); // Last 100 blocks
                const uniqueUsers = new Set(events.map(e => e.args.creator));
                const monthlyStakes = {}; // Aggregate by month
                events.forEach(e => {
                    const month = new Date(Number(e.blockTimestamp) * 1000).getMonth();
                    monthlyStakes[month] = (monthlyStakes[month] || 0) + Number(e.args.stake);
                });
                const labels = Object.keys(monthlyStakes).map(m => `Month ${m}`);
                const stakesData = Object.values(monthlyStakes).map(s => ethers.utils.formatEther(s));
                const usersData = Array(labels.length).fill(uniqueUsers.size / labels.length); // Avg

                // Traction Chart
                if (devChart) devChart.destroy();
                const ctx = document.getElementById('devChart').getContext('2d');
                devChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels, 
                        datasets: [
                            { label: 'Monthly Stakes (CORE)', data: stakesData, borderColor: 'var(--bitcoin-orange)' },
                            { label: 'Unique Users', data: usersData, borderColor: 'var(--core-green)' }
                        ] 
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });

                // Usage Chart
                if (usageChart) usageChart.destroy();
                const usageCtx = document.getElementById('usageChart').getContext('2d');
                usageChart = new Chart(usageCtx, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [
                            { label: 'Games per Month', data: [Math.random()*100, ...], backgroundColor: 'var(--core-green)' },
                            { label: 'Avg Engagement (Moves/Game)', data: [5, ...], backgroundColor: 'var(--bitcoin-orange)' }
                        ] 
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });

                document.getElementById('devTxList').innerHTML = `<div>Total Users: ${uniqueUsers.size} | Total Games: ${events.length}</div>`;
            } catch (error) {
                console.error(error);
            }
        }

        function toggleSettings() {
            showAlert('Settings: Sound, Difficulty, etc. (Coming soon)', 'info');
        }

        // Other functions same as before, with renderBoard call in loadGame, etc.
        // On Load
        document.addEventListener('DOMContentLoaded', () => {
            initTokenSelect();
            loadLeaderboard();
            loadTournaments();
            updateCreateButton();
            document.getElementById('stakeAmount').addEventListener('input', updateCreateButton);
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', connectWallet);
                window.ethereum.on('chainChanged', () => location.reload());
            }
        });
    </script>
</body>
</html>
