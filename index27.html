<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>CrossRealm â€¢ On-Chain Checkers & Chess on Core</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> <!-- In-game chat & lobby -->
    <script src="https://cdn.jsdelivr.net/npm/@gelatonetwork/relay-sdk@1.0.1/dist/index.umd.min.js"></script> <!-- Gelato prep -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQ3Jvc3NSZWalmIiwic2hvcnRfbmFtZSI6IkNSUiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5IjoiZnVsbHNjcmVlbiIsImJhY2tncm91bmRfY29sb3IiOiIjMGYwZjBmIiwidGhlbWVfY29sb3IiOiIjZjc5MzFhIn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --bitcoin-orange: #f7931a;
            --burnt-orange: #cc6600;
            --core-green: #00ff88;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #999;
            --success: var(--core-green);
            --error: #ff4444;
            --gradient-primary: linear-gradient(135deg, var(--bitcoin-orange), var(--burnt-orange));
            --gradient-success: linear-gradient(135deg, var(--core-green), #00cc6a);
            --wood-bg: linear-gradient(135deg, #D2B48C 0%, #8B4513 50%, #A0522D 100%);
            --wood-light: #DEB887;
            --wood-dark: #8B4513;
            --piece-black: #000;
            --piece-red: #8B0000;
            --highlight-selected: #4169E1;
            --highlight-possible: #FFD700;
            --wood-frame: #8B4513;
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(247, 147, 26, 0.03) 2px, rgba(247, 147, 26, 0.03) 4px);
            overflow-x: hidden;
        }
        body.landscape-prompt::before {
            content: 'Rotate to landscape for best play';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--gradient-primary);
            color: #000;
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            text-align: center;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: var(--card-bg);
            border: 2px solid var(--bitcoin-orange);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(247, 147, 26, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--bitcoin-orange);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .tagline {
            color: var(--text-dim);
            font-size: 11px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .wallet-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .wallet-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wallet-status {
            font-size: 12px;
            color: var(--text-dim);
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            white-space: nowrap;
        }
        .wallet-balance {
            font-size: 12px;
            color: var(--core-green);
            font-weight: bold;
        }
        .wallet-address {
            color: var(--bitcoin-orange);
            font-weight: bold;
        }
        .wallet-right {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 26, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .disconnect-btn {
            background: var(--error);
            color: white;
        }
        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: var(--gradient-primary);
            color: #000;
            border-color: var(--bitcoin-orange);
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none !important;
        }
        .board-wrapper {
            position: relative;
            margin: 20px auto;
            width: min(90vw, 400px);
            aspect-ratio: 1;
            max-width: 400px;
            background: var(--wood-frame);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        .board-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            height: 100%;
            background: var(--wood-bg);
            border: 2px solid var(--wood-frame);
            border-radius: 4px;
        }
        .board-labels-top, .board-labels-bottom {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
            color: var(--text-dim);
        }
        .board-label {
            width: 12.5%;
            text-align: center;
        }
        .board-labels-side {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12.5%;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dim);
        }
        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(20px, 8vw, 32px);
            cursor: pointer;
            user-select: none;
            border: 1px solid rgba(0,0,0,0.3);
            transition: background 0.2s;
        }
        .square.light {
            background: var(--wood-light);
        }
        .square.dark {
            background: var(--wood-dark);
        }
        .square.selected {
            background: var(--highlight-selected) !important;
        }
        .square.possible {
            background: var(--highlight-possible) !important;
        }
        .player-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: var(--wood-frame);
            border-radius: 4px;
            color: #000;
            font-weight: bold;
        }
        .status-bar {
            background: var(--gradient-success);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .status-fill {
            height: 100%;
            background: var(--core-green);
            width: 77%; /* From sample */
            transition: width 0.3s;
        }
        .cpu-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: var(--gradient-success);
            color: #000;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        .game-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .game-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .leader-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dim);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
        }
        #chatContainer {
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            background: var(--card-bg);
            margin-top: 10px;
            border-radius: 4px;
        }
        #chatInput {
            width: 70%;
            padding: 10px;
        }
        #sendChat {
            width: 28%;
            padding: 10px;
        }
        #devPanel {
            background: rgba(247, 147, 26, 0.1);
            border: 1px solid var(--bitcoin-orange);
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        #installPrompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-primary);
            color: #000;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        .bridge-section {
            margin-top: 20px;
        }
        .lobby-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .lobby-filters input, .lobby-filters select {
            padding: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            border-radius: 4px;
        }
        .online-players {
            background: var(--gradient-success);
            color: #000;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        @media (max-width: 768px) and (orientation: portrait) {
            body { class: landscape-prompt; }
            .board-wrapper { width: 80vw; }
        }
        @media (orientation: landscape) {
            body { padding: 5px; }
            .board-wrapper { width: 60vw; max-width: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">CrossRealm</h1>
            <p class="tagline">On-Chain Gaming on Core</p>
            <div class="wallet-bar">
                <div class="wallet-left">
                    <div class="wallet-status hidden" id="walletStatus">
                        <span class="wallet-address" id="walletAddress"></span>
                        <span class="wallet-balance" id="walletBalance">0 CORE</span>
                    </div>
                </div>
                <div class="wallet-right">
                    <button id="connectBtn">Connect Wallet</button>
                    <button id="disconnectBtn" class="disconnect-btn hidden">Disconnect</button>
                </div>
            </div>
        </header>
        <nav class="tab-bar">
            <button class="tab-btn active" data-tab="home">Home</button>
            <button class="tab-btn" data-tab="lobby">Lobby</button>
            <button class="tab-btn" data-tab="play">Play</button>
            <button class="tab-btn" data-tab="tournaments">Tournaments</button>
            <button class="tab-btn" data-tab="profile">Profile</button>
            <button class="tab-btn" data-tab="staking">Staking</button>
            <button class="tab-btn" data-tab="nfts">NFTs</button>
            <button class="tab-btn" data-tab="bridge">Bridge</button>
        </nav>
        <!-- Home Tab -->
        <section id="home" class="tab-content">
            <div class="card">
                <h2>Global Stats</h2>
                <div class="stats-grid" id="globalStats">
                    <div class="stat-card">Total Games<br><span id="totalGames">0</span></div>
                    <div class="stat-card">Active Games<br><span id="activeGames">0</span></div>
                    <div class="stat-card">Prize Pool<br><span id="prizePool">0 CORE</span></div>
                </div>
                <canvas id="globalChart" width="400" height="200"></canvas>
            </div>
            <div class="card">
                <h2>Leaderboard</h2>
                <div id="leaderboard"></div>
            </div>
        </section>
        <!-- Lobby Tab (New Multiplayer Lobby) -->
        <section id="lobby" class="tab-content hidden">
            <div class="card">
                <h2>Multiplayer Lobby</h2>
                <div class="online-players" id="onlinePlayers">Online Players: 0</div>
                <div class="lobby-filters">
                    <input type="text" id="lobbySearch" placeholder="Search games by type...">
                    <select id="lobbyFilter">
                        <option value="all">All Games</option>
                        <option value="chess">Chess Only</option>
                        <option value="checkers">Checkers Only</option>
                    </select>
                    <button id="refreshLobby">Refresh</button>
                </div>
                <div id="lobbyGamesList" class="game-list"></div>
                <div id="lobbyChat">
                    <h3>Lobby Chat</h3>
                    <div id="lobbyChatContainer"></div>
                    <input type="text" id="lobbyChatInput" placeholder="Chat in lobby...">
                    <button id="sendLobbyChat">Send</button>
                </div>
            </div>
        </section>
        <!-- Play Tab -->
        <section id="play" class="tab-content hidden">
            <div class="card">
                <h2>Create Game</h2>
                <div id="currentGameInfo"></div> <!-- Added missing element -->
                <div class="form-group">
                    <label>Game Type</label>
                    <select id="gameType">
                        <option value="chess">Chess</option>
                        <option value="checkers">Checkers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stake (min 1 USD equiv ~0.0005 CORE)</label>
                    <input type="number" id="stakeAmount" placeholder="0.001" step="0.0001" min="0.0005">
                </div>
                <div class="form-group">
                    <label>Private?</label>
                    <input type="checkbox" id="isPrivate">
                </div>
                <div class="form-group">
                    <label>Referral Address</label>
                    <input type="text" id="referralAddr" placeholder="0x...">
                </div>
                <div class="form-group">
                    <label>AI Game? (CPU Opponent)</label>
                    <input type="checkbox" id="isAI">
                </div>
                <button id="createGameBtn" disabled>Create Game</button>
            </div>
            <div class="card">
                <h2>Open Games</h2>
                <div id="openGamesList" class="game-list"></div>
            </div>
            <div class="card">
                <h2>Current Game</h2>
                <div class="player-status" id="playerStatusTop">
                    <span>CPU</span>
                    <div class="status-bar"><div class="status-fill" style="width: 77%"></div></div>
                    <span>77%</span>
                </div>
                <div class="board-wrapper">
                    <div class="board-labels-side" id="sideLabels"></div>
                    <div class="board-container" id="boardContainer"></div>
                    <div class="board-labels-top" id="topLabels">A B C D E F G H</div>
                    <div class="board-labels-bottom" id="bottomLabels">1 2 3 4 5 6 7 8</div> <!-- Fixed to 8x8 -->
                </div>
                <div class="player-status" id="playerStatusBottom">
                    <span>Player</span>
                    <div class="status-bar"><div class="status-fill" style="width: 22%"></div></div>
                    <span>22%</span>
                </div>
                <div id="moveControls">
                    <input type="text" id="moveInput" placeholder="Enter move (e.g., a3-b4 for checkers)">
                    <button id="makeMoveBtn">Make Move</button>
                </div>
                <button id="endGameBtn" class="hidden">End Game (I Win)</button>
                <!-- In-game Chat -->
                <div id="chatSection" class="hidden">
                    <h3>Chat</h3>
                    <div id="chatContainer"></div>
                    <input type="text" id="chatInput" placeholder="Type message...">
                    <button id="sendChat">Send</button>
                </div>
            </div>
        </section>
        <!-- Tournaments Tab -->
        <section id="tournaments" class="tab-content hidden">
            <div class="card">
                <h2>Active Tournaments</h2>
                <div id="tournamentList" class="game-list"></div>
            </div>
        </section>
        <!-- Profile Tab -->
        <section id="profile" class="tab-content hidden">
            <div class="card">
                <h2>User Stats</h2>
                <div class="stats-grid" id="userStats"></div>
                <p id="winRate"></p>
                <button id="claimRewardsBtn">Claim Rewards</button>
            </div>
        </section>
        <!-- Staking Tab -->
        <section id="staking" class="tab-content hidden">
            <div class="card">
                <h2>Staking</h2>
                <div class="stats-grid">
                    <div class="stat-card">Staked<br><span id="stakedAmount">0</span></div>
                    <div class="stat-card">Rewards<br><span id="pendingRewards">0</span></div>
                    <div class="stat-card">APY<br>15%</div>
                </div>
                <div class="form-group">
                    <label>Stake Amount</label>
                    <input type="number" id="stakeInput" placeholder="0.01" step="0.01">
                    <button id="stakeBtn">Stake</button>
                </div>
                <button id="withdrawBtn">Withdraw</button>
                <button id="claimStakingRewardsBtn">Claim Rewards</button>
            </div>
        </section>
        <!-- NFTs Tab -->
        <section id="nfts" class="tab-content hidden">
            <div class="card">
                <h2>Your NFTs</h2>
                <div id="nftGrid" class="stats-grid"></div>
                <div class="form-group">
                    <label>Token ID</label>
                    <input type="number" id="tokenIdInput">
                    <label>Game Type</label>
                    <select id="equipGameType">
                        <option value="chess">Chess</option>
                        <option value="checkers">Checkers</option>
                    </select>
                    <button id="equipNFTBtn">Equip NFT</button>
                </div>
            </div>
        </section>
        <!-- Bridge Tab -->
        <section id="bridge" class="tab-content hidden">
            <div class="card">
                <h2>LayerZero Bridge</h2>
                <p>Bridge tokens from other chains to Core for staking/rewards.</p>
                <div class="bridge-section">
                    <select id="bridgeFromChain">
                        <option value="ethereum">Ethereum (srcEid 30101)</option>
                        <option value="bsc">BSC (srcEid 30102)</option>
                    </select>
                    <input type="number" id="bridgeAmount" placeholder="Amount (e.g., 1 USDT)">
                    <button id="bridgeBtn">Bridge to Core</button>
                </div>
            </div>
        </section>
        <!-- Dev Panel -->
        <section id="devPanel" class="card hidden">
            <h2>Dev Panel</h2>
            <div id="devTxList"></div>
            <canvas id="devChart" width="400" height="200"></canvas>
            <button id="claimDevShareBtn">Claim Dev Share</button>
            <button id="claimMultiDevShareBtn">Claim Multi Dev Share</button>
        </section>
    </div>
    <div id="installPrompt" class="hidden">
        Install CrossRealm? <button onclick="installPWA()">Install</button> <button onclick="dismissInstall()">Dismiss</button>
    </div>
    <script>
        // Contract Addresses & ABIs (unchanged from deployed)
        const HUB_ADDRESS = '0xD2Ff26ff20F8ca249b33808d85C38C16e6b9721f';
        const REWARDS_ADDRESS = '0x3fd3288144DFbFa5C728fD46aF126073526a5E22';
        const NFT_ADDRESS = '0x16A88d66376791a508F1aAdBc6Df4c112074EB91';
        const STAKING_ADDRESS = '0xDADa11419AC555Bf840e6492C4D7a212F90249DD';
        const TOURNAMENT_ADDRESS = '0xD25474e4510bc0967c0876Ef6ef5088782Bb2e4E';
        const CORE_TOKEN = '0x0000000000000000000000000000000000000000'; // Native CORE
        const VERIFIER_ADDRESSES = {
            chess: '0xFa1463b462d937b4F3ffD4675E1F5bA6Dac9884E',
            checkers: '0x634cBAE767EdabBa207FA7c2e790808A2bFDB3DD'
        };
        // ABIs (full from contracts, abbreviated here for spaceâ€”use previous full versions)
        const HUB_ABI = [ /* Insert full HUB_ABI from earlier */ ];
        const REWARDS_ABI = [ /* Full REWARDS_ABI */ ];
        const NFT_ABI = [ /* Full NFT_ABI */ ];
        const STAKING_ABI = [ /* Full STAKING_ABI */ ];
        const TOURNAMENT_ABI = [ /* Full TOURNAMENT_ABI */ ];
        // Globals
        let provider, signer, userAddress, contracts = {}, hubContract, rewardsContract, nftContract, stakingContract, tournamentContract;
        let currentGameId = null;
        let socket; // Chat & Lobby
        let chessInstance;
        let isDev = false;
        let devChart, globalChart;
        let deferredPrompt;
        let onlinePlayers = 0; // Mock for lobby
        const CHESS_PIECES = { 'K': 'â™”', 'Q': 'â™•', 'R': 'â™–', 'B': 'â™—', 'N': 'â™˜', 'P': 'â™™', 'k': 'â™š', 'q': 'â™›', 'r': 'â™œ', 'b': 'â™', 'n': 'â™ž', 'p': 'â™Ÿ' };
        const CHECKERS_PIECES = { 'b': 'âš«', 'w': 'âšª', 'B': 'ðŸ”´', 'W': 'ðŸ”µ' };
        // App
        const app = {
            async init() {
                await this.connectWallet();
                this.setupListeners();
                this.loadGlobalStats();
                this.loadLeaderboard();
                this.loadOpenGames();
                this.loadLobbyGames(); // New: Load lobby
                this.loadTournaments();
                this.updateWalletStatus();
                // Socket for chat & lobby (replace with your server)
                socket = io('wss://your-chat-server.com');
                socket.on('chat message', (msg) => this.appendChatMessage(msg));
                socket.on('lobby message', (msg) => this.appendLobbyChatMessage(msg));
                socket.on('game created', (game) => {
                    this.loadOpenGames();
                    this.loadLobbyGames();
                });
                socket.on('game joined', (gameId) => {
                    this.loadOpenGames();
                    this.loadLobbyGames();
                });
                socket.on('online count', (count) => {
                    onlinePlayers = count;
                    document.getElementById('onlinePlayers').textContent = `Online Players: ${count}`;
                });
                // Mobile orientation
                if (screen.orientation) screen.orientation.addListener('change', this.handleOrientation);
                else window.addEventListener('orientationchange', this.handleOrientation);
                setInterval(() => {
                    if (currentGameId) this.loadGame(currentGameId);
                    if (userAddress) {
                        this.loadUserStats();
                        this.updateWalletBalance();
                    }
                    this.loadLobbyGames(); // Poll lobby
                }, 10000);
            },
            handleOrientation() {
                if (window.innerWidth < window.innerHeight) {
                    document.body.classList.add('landscape-prompt');
                } else {
                    document.body.classList.remove('landscape-prompt');
                }
            },
            setupListeners() {
                document.getElementById('connectBtn').onclick = () => this.connectWallet();
                document.getElementById('disconnectBtn').onclick = () => this.disconnectWallet();
                document.getElementById('createGameBtn').onclick = () => this.createGame();
                document.getElementById('makeMoveBtn').onclick = () => this.makeMove();
                document.getElementById('endGameBtn').onclick = () => this.endGame();
                document.getElementById('sendChat').onclick = () => this.sendChatMessage();
                document.getElementById('sendLobbyChat').onclick = () => this.sendLobbyChatMessage();
                document.getElementById('refreshLobby').onclick = () => this.loadLobbyGames();
                // Lobby filters
                document.getElementById('lobbySearch').oninput = (e) => this.filterLobbyGames(e.target.value);
                document.getElementById('lobbyFilter').onchange = (e) => this.filterLobbyGames('', e.target.value);
                document.getElementById('bridgeBtn').onclick = () => this.bridgeTokens();
                // Tab switch
                document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = (e) => this.switchTab(e.target.dataset.tab));
                // Min stake validation
                document.getElementById('stakeAmount').oninput = (e) => {
                    const stake = parseFloat(e.target.value);
                    document.getElementById('createGameBtn').disabled = stake < 0.0005;
                };
                // Wallet events
                if (window.ethereum) {
                    window.ethereum.on('accountsChanged', () => location.reload());
                    window.ethereum.on('chainChanged', () => location.reload());
                }
            },
            async connectWallet() {
                try {
                    if (!window.ethereum) throw new Error('Install MetaMask');
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    hubContract = new ethers.Contract(HUB_ADDRESS, HUB_ABI, signer);
                    rewardsContract = new ethers.Contract(REWARDS_ADDRESS, REWARDS_ABI, signer);
                    nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
                    stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
                    tournamentContract = new ethers.Contract(TOURNAMENT_ADDRESS, TOURNAMENT_ABI, signer);
                    await this.updateWalletBalance();
                    await this.loadOwner();
                    this.updateWalletStatus();
                    this.alert('Wallet connected!', 'success');
                } catch (e) {
                    this.alert('Connection failed: ' + e.message, 'error');
                }
            },
            async updateWalletBalance() {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('walletBalance').textContent = `${parseFloat(ethers.utils.formatEther(balance)).toFixed(4)} CORE`;
            },
            async loadOwner() {
                const owner = await hubContract.owner();
                isDev = userAddress.toLowerCase() === owner.toLowerCase();
                console.log('isDev:', isDev, 'User:', userAddress, 'Owner:', owner); // Debug log
                if (isDev) {
                    document.getElementById('devPanel').classList.remove('hidden');
                    console.log('Dev panel shown');
                }
            },
            updateWalletStatus() {
                const statusEl = document.getElementById('walletStatus');
                const addrEl = document.getElementById('walletAddress');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                if (userAddress) {
                    statusEl.classList.remove('hidden');
                    addrEl.textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                    connectBtn.classList.add('hidden');
                    disconnectBtn.classList.remove('hidden');
                } else {
                    statusEl.classList.add('hidden');
                    connectBtn.classList.remove('hidden');
                    disconnectBtn.classList.add('hidden');
                }
            },
            disconnectWallet() {
                userAddress = null;
                this.updateWalletStatus();
                this.alert('Disconnected', 'info');
            },
            async createGame() {
                try {
                    const gameType = document.getElementById('gameType').value;
                    const stake = ethers.utils.parseEther(document.getElementById('stakeAmount').value);
                    if (stake.lt(ethers.utils.parseEther('0.0005'))) throw new Error('Min stake required');
                    const isPrivate = document.getElementById('isPrivate').checked;
                    const referral = document.getElementById('referralAddr').value || ethers.constants.AddressZero;
                    const isAI = document.getElementById('isAI').checked;
                    const verifier = VERIFIER_ADDRESSES[gameType];
                    const tx = await hubContract.createGame(gameType, stake, CORE_TOKEN, isPrivate, referral, isAI, false, verifier, { value: stake });
                    this.alert('Creating game...', 'info');
                    const receipt = await tx.wait();
                    const event = receipt.events.find(e => e.event === 'GameCreated');
                    if (event) {
                        currentGameId = event.args.id.toNumber();
                        this.alert(`Game #${currentGameId} created!`, 'success');
                        socket.emit('game created', { id: currentGameId, gameType }); // Notify lobby
                        this.switchTab('play');
                        this.loadGame(currentGameId);
                    }
                } catch (e) {
                    this.alert('Create failed: ' + e.message, 'error');
                }
            },
            async loadOpenGames() {
                try {
                    const count = await hubContract.gameCount();
                    const listEl = document.getElementById('openGamesList');
                    listEl.innerHTML = '';
                    for (let i = 1; i <= count.toNumber(); i++) {
                        const game = await hubContract.games(i);
                        if (game.active && game.player2 === ethers.constants.AddressZero) {
                            const item = document.createElement('div');
                            item.className = 'game-item';
                            item.innerHTML = `
                                <span>ID: ${game.id} - ${game.gameType} - Stake: ${ethers.utils.formatEther(game.stake)} CORE</span>
                                <button onclick="app.joinGame(${game.id.toNumber()})">Join</button>
                            `;
                            listEl.appendChild(item);
                        }
                    }
                } catch (e) {
                    console.error(e);
                }
            },
            async loadLobbyGames() {
                // Reuse open games logic, but with filters
                await this.loadOpenGames(); // Populate base
                const listEl = document.getElementById('lobbyGamesList');
                listEl.innerHTML = listEl.innerHTML || document.getElementById('openGamesList').innerHTML; // Copy from open games
                this.filterLobbyGames(document.getElementById('lobbySearch').value, document.getElementById('lobbyFilter').value);
            },
            filterLobbyGames(search = '', filter = 'all') {
                const listEl = document.getElementById('lobbyGamesList');
                const items = Array.from(listEl.children);
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const matchesSearch = !search || text.includes(search.toLowerCase());
                    const matchesFilter = filter === 'all' || text.includes(filter);
                    item.style.display = matchesSearch && matchesFilter ? 'flex' : 'none';
                });
            },
            async joinGame(id) {
                try {
                    const game = await hubContract.games(id);
                    const tx = await hubContract.joinGame(id, { value: game.stake });
                    await tx.wait();
                    this.alert('Joined!', 'success');
                    currentGameId = id;
                    socket.emit('game joined', id); // Notify lobby
                    this.loadGame(id);
                } catch (e) {
                    this.alert('Join failed: ' + e.message, 'error');
                }
            },
            async loadGame(id) {
                try {
                    currentGameId = id;
                    const game = await hubContract.games(id);
                    const infoEl = document.getElementById('currentGameInfo');
                    if (infoEl) {
                        infoEl.innerHTML = `
                            <p>Game Type: ${game.gameType}</p>
                            <p>Stake: ${ethers.utils.formatEther(game.stake)} CORE</p>
                            <p>Creator: ${game.creator.slice(0,6)}... | Player 2: ${game.player2 === ethers.constants.AddressZero ? 'Open' : game.player2.slice(0,6)}...</p>
                            <p>Active: ${game.active} | Turn: ${game.turn === 0 ? 'Creator' : 'Player 2'}</p>
                        `;
                    }
                    this.renderBoard(game.gameType, game.fen);
                    document.getElementById('endGameBtn').classList.toggle('hidden', !game.active || (userAddress.toLowerCase() !== game.creator.toLowerCase() && userAddress.toLowerCase() !== game.player2.toLowerCase()));
                    document.getElementById('chatSection').classList.remove('hidden');
                    socket.emit('join game', id);
                    // Update status bars (mock from sample)
                    document.querySelector('#playerStatusTop .status-fill').style.width = game.isAI ? '77%' : '50%';
                    document.querySelector('#playerStatusBottom .status-fill').style.width = '22%';
                } catch (e) {
                    console.error('Load game error:', e);
                    this.alert('Load game failed: ' + e.message, 'error');
                }
            },
            renderBoard(gameType, fen) {
                try {
                    const container = document.getElementById('boardContainer');
                    container.innerHTML = '';
                    // Side labels (fixed to 8x8)
                    const sideLabels = document.getElementById('sideLabels');
                    sideLabels.innerHTML = '';
                    for (let i = 8; i >= 1; i--) {
                        const label = document.createElement('div');
                        label.className = 'board-label';
                        label.textContent = i;
                        sideLabels.appendChild(label);
                    }
                    // Top/bottom labels (fixed)
                    document.getElementById('topLabels').textContent = 'A B C D E F G H';
                    document.getElementById('bottomLabels').textContent = '1 2 3 4 5 6 7 8';
                    if (gameType === 'chess') {
                        this.renderChessBoard(fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');
                        chessInstance = new Chess(fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');
                    } else if (gameType === 'checkers') {
                        this.renderCheckersBoard(fen || 'bwbw/4/4/4/4/wbwb/4/4 b');
                    }
                    // Click handlers
                    document.querySelectorAll('.square').forEach((sq, idx) => {
                        sq.onclick = () => this.selectSquare(idx, gameType);
                    });
                } catch (e) {
                    console.error('Render board error:', e);
                    this.alert('Board render failed: ' + e.message, 'error');
                }
            },
            renderChessBoard(fen) {
                const board = new Chess(fen).board();
                const container = document.getElementById('boardContainer');
                for (let row = 7; row >= 0; row--) {
                    for (let col = 0; col < 8; col++) {
                        const piece = board[row][col];
                        const sq = document.createElement('div');
                        sq.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                        sq.innerHTML = piece ? CHESS_PIECES[piece.type.toUpperCase() + (piece.color === 'w' ? '' : piece.type.toLowerCase())] : '&nbsp;';
                        container.appendChild(sq);
                    }
                }
            },
            renderCheckersBoard(fen) {
                const rows = fen.split('/').reverse();
                const container = document.getElementById('boardContainer');
                for (let row = 0; row < 8; row++) {
                    let rowStr = rows[row].replace(/\d/g, (num) => ' '.repeat(parseInt(num)));
                    for (let col = 0; col < 8; col++) {
                        const char = rowStr[col] || ' ';
                        const sq = document.createElement('div');
                        sq.className = `square ${row % 2 === col % 2 ? 'dark' : 'light'}`; // Checkers pattern
                        sq.innerHTML = CHECKERS_PIECES[char] || '&nbsp;';
                        container.appendChild(sq);
                    }
                }
            },
            selectSquare(idx, type) {
                document.querySelectorAll('.square').forEach(sq => sq.classList.remove('selected', 'possible'));
                document.querySelectorAll('.square')[idx].classList.add('selected');
                if (type === 'chess' && chessInstance) {
                    const square = this.indexToSquare(idx);
                    const moves = chessInstance.moves({ square, verbose: true });
                    moves.forEach(move => {
                        const toIdx = this.squareToIndex(move.to);
                        document.querySelectorAll('.square')[toIdx].classList.add('possible');
                    });
                }
            },
            indexToSquare(idx) {
                const row = 7 - Math.floor(idx / 8);
                const col = idx % 8;
                return String.fromCharCode(97 + col) + (row + 1);
            },
            squareToIndex(square) {
                const col = square.charCodeAt(0) - 97;
                const row = parseInt(square[1]) - 1;
                return (7 - row) * 8 + col;
            },
            async makeMove() {
                try {
                    const move = document.getElementById('moveInput').value;
                    let newFen = '';
                    if (currentGameId && chessInstance) {
                        chessInstance.move(move);
                        newFen = chessInstance.fen();
                    } else {
                        newFen = 'updated-fen-stub'; // From verifier
                    }
                    const proof = '0x'; // Gelato stub
                    const tx = await hubContract.makeMove(currentGameId, move, newFen, proof);
                    this.alert('Making move...', 'info');
                    await tx.wait();
                    this.alert('Move made!', 'success');
                    this.loadGame(currentGameId);
                } catch (e) {
                    this.alert('Move failed: ' + e.message, 'error');
                }
            },
            async endGame() {
                try {
                    const creatorWins = confirm('Did creator win?');
                    const tx = await hubContract.endGame(currentGameId, creatorWins);
                    await tx.wait();
                    this.alert('Game ended!', 'success');
                    currentGameId = null;
                } catch (e) {
                    this.alert('End failed: ' + e.message, 'error');
                }
            },
            sendChatMessage() {
                const msg = document.getElementById('chatInput').value.trim();
                if (!msg || !currentGameId) return;
                socket.emit('chat message', { gameId: currentGameId, user: userAddress, msg });
                document.getElementById('chatInput').value = '';
            },
            appendChatMessage(data) {
                if (data.gameId !== currentGameId) return;
                const container = document.getElementById('chatContainer');
                container.innerHTML += `<p><strong>${data.user.slice(0,6)}...</strong>: ${data.msg}</p>`;
                container.scrollTop = container.scrollHeight;
            },
            sendLobbyChatMessage() {
                const msg = document.getElementById('lobbyChatInput').value.trim();
                if (!msg) return;
                socket.emit('lobby message', { user: userAddress, msg });
                document.getElementById('lobbyChatInput').value = '';
            },
            appendLobbyChatMessage(data) {
                const container = document.getElementById('lobbyChatContainer');
                container.innerHTML += `<p><strong>${data.user.slice(0,6)}...</strong>: ${data.msg}</p>`;
                container.scrollTop = container.scrollHeight;
            },
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(tab).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active'); // Fixed: No event dependency
                if (tab === 'play' && currentGameId) this.loadGame(currentGameId);
            },
            async bridgeTokens() {
                const chain = document.getElementById('bridgeFromChain').value;
                const amount = document.getElementById('bridgeAmount').value;
                // Stub - integrate LayerZero SDK here
                this.alert(`Bridging ${amount} from ${chain} to Core (stub - tx pending)...`, 'info');
                // Real impl: Call LayerZero endpoint with dstEid 401XX for Core
            },
            async loadUserStats() {
                try {
                    const [games, wins, losses, elo] = await Promise.all([
                        rewardsContract.userGamesPlayed(userAddress),
                        rewardsContract.userWins(userAddress),
                        rewardsContract.userLosses(userAddress),
                        rewardsContract.userElo(userAddress)
                    ]);
                    const winRate = games.gt(0) ? ((wins.toNumber() / games.toNumber()) * 100).toFixed(1) : 0;
                    document.getElementById('userStats').innerHTML = `
                        <div class="stat-card">Games<br>${games.toString()}</div>
                        <div class="stat-card">Wins<br>${wins.toString()}</div>
                        <div class="stat-card">Losses<br>${losses.toString()}</div>
                        <div class="stat-card">ELO<br>${elo.toString()}</div>
                    `;
                    document.getElementById('winRate').innerHTML = `<strong>Win Rate: ${winRate}%</strong>`;
                } catch (e) {
                    console.error(e);
                }
            },
            // Staking, NFTs, Tournaments, GlobalStats, Leaderboard, DevPanel methods (unchanged from previous, abbreviated)
            async stake() { /* Impl as before */ },
            async loadStakingStats() { /* Impl */ },
            async loadNFTs() { /* Impl */ },
            async loadTournaments() { /* Impl */ },
            async loadGlobalStats() { /* Chart impl */ },
            async loadLeaderboard() { /* Mock/impl */ },
            async loadDevPanel() { /* Chart impl */ },
            alert(msg, type = 'success') {
                const el = document.createElement('div');
                el.className = `alert ${type}`;
                el.style.background = type === 'success' ? 'var(--success)' : 'var(--error)';
                el.textContent = msg;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        };
        // PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.remove('hidden');
        });
        function installPWA() {
            deferredPrompt.prompt();
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.add('hidden');
        }
        function dismissInstall() {
            document.getElementById('installPrompt').classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
